var _ = require('lodash')._;

module.exports = once = function() {
    var origArgs = arguments;
    return function(req, res, next) {
        var args = _.toArray(origArgs);
        for (var i in args) {
            if (args.hasOwnProperty(i)) {
                args[i](req, res, callback(i));
            }
        }

        var callbackReturned = false;
        function callback(numb) {
            return function(err) {
                if (callbackReturned) {
                    return;
                }
                if (err) {
                    callbackReturned = true;
                    next(err);
                } else {
                    delete args[numb];
                    if (Object.keys(args).length === 0) {
                        callbackReturned = true;
                        next();
                    }
                }
            }
        }
    }
};