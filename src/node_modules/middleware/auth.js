module.exports = function(macValidator) {
    var macParser = require('lib/mac/parser');

    return function(req, res, next) {
        var authorizationHeader = req.headers['authorization'];
        try {
            var params = macParser.parse(authorizationHeader);
        } catch (e) {
            return next(e);
        }

        if (!params) {
            return next();
        }

        macValidator.validateRequest(req, params, params.id, function(err, credentials, token) {
            if (err) {
                next(err);
            } else {
                req.credentials = credentials;
                req.token = token;
                next();
            }
        });
    };
};