module.exports = function(macValidator, async) {
    var macParser = require('lib/mac/parser');

    return function(req, res, next) {
        var authorizationHeader = req.headers['authorization'];
        try {
            var params = macParser.parse(authorizationHeader);
        } catch (e) {
            next(e);
        }

        if (!params) {
            next();
            return;
        }

        var callback;
        if (async) {
            callback = function(err, credentials, token) {
                if (!err) {
                    req.credentials = credentials;
                    req.token = token;
                }
                req.emit('credentialsReady');
            };
        } else {
            callback = function(err, credentials, token) {
                if (err) {
                    next(err);
                } else {
                    req.credentials = credentials;
                    req.token = token;
                    next();
                }
            };
        }

        macValidator.validateRequest(req, params, params.id, callback);

        if (async) {
            next();
        }
    };
};